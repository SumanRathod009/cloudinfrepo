AWSTemplateFormatVersion: 2010-09-09
Description: 'Catalog Product: Self-service product.'

# CloudFormation parameter UI definitions
Metadata:
  Identifier:
    Value: sc-product
  Release:
    Version: '1.0'

#Input Parameters to be configured for the service catalog product 
Parameters:
  NameSuffix:
    Type: String
    AllowedPattern: '[a-zA-Z0-9_-]*'
    Description: 'Suffix to attach to name definition. Final name will be: <org_name: gilead>-<lob>-<aws_account_id>-<environment: sandbox | dev | test | prod>-<aws_region>-<data: raw | curated | processed | artifacts | logs>-<suffix>'
    ConstraintDescription: 'Can contain only alphanumeric characters, dashes and underscores'
  HomeRegion:
    Description: 'Home region of the bucket, which can be any supported region, considering any data sovereignty and regional requirements.'
    Type: String
    Default: 'us-west-1'
    AllowedValues:
      - us-west-1
      - us-west-2
      - us-east-1
      - eu-west-1
      - eu-central-1
      - ca-central-1
      - ap-southeast-2
    ConstraintDescription: 'Enter a valid approved region. Default is us-west-1'
  Description:
    Type: String
    Description: 'A short description of the purpose of the bucket.'
    AllowedPattern: '[a-zA-Z0-9_-]*'
    ConstraintDescription: 'Can contain only alphanumeric characters, dashes and underscores up to 32 characters'
  BucketOwner:
    Type: String
    Description: 'An email distribution list to contact for issues or support.'
    AllowedPattern: '[a-zA-Z0-9_-]*'
    ConstraintDescription: 'Can contain only alphanumeric characters, dashes and underscores up to 32 characters'
  Environment:
    Type: String  
    Description: 'Highest environment that the bucket supports, and not necessarily the account environment in which the bucket is created.'
    AllowedValues:
      - dev
      - test
      - prod
    ConstraintDescription: 'Can contain only alphanumeric characters, dashes and underscores up to 32 characters'
  DataProcessStage:
    Type: String  
    Description: 'The stage in the data processing cycle for the bucket contents.'
    AllowedValues:
      - Raw
      - Curated
      - Processed
      - Artifacts
      - Logs
  LineOfBusiness:
    Type: String
    Description: 'Name of the LOB in which the product should be launched.'
    AllowedPattern: '[a-zA-Z0-9_-]*'
    ConstraintDescription: 'Can contain only alphanumeric characters, dashes and underscores up to 32 characters'
  TargetAccountId:
    Description: 'ID of AWS Account in which the product should be launched.'
    Type: String
    MaxLength: '50'
    AllowedPattern: '^\d{12}$'
    ConstraintDescription: 'Can contain numbers up to 12 characters.'
    
    

Resources:  
  TerraformLauncher:
    Type: 'Custom::TerraformLauncher'
    Properties:
      ServiceToken: !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:custom_resource_lambda_7'
      SchemaVersion: 'v1'
      StackName: !Ref 'AWS::StackName'
      ProductDetail:
        AccountId: !Ref TargetAccountId
        NamePrefix: S3Bucket
        AwsRegion: !Ref HomeRegion
        ModulePath: 'modules/edp/aws_s3_bucket'
        ModuleVersion: '1.0.0'
        InputParameters:
          NameSuffix: !Ref NameSuffix
          HomeRegion: !Ref HomeRegion
          Description: !Ref Description
          Environment: !Ref Environment
          BucketOwner: !Ref BucketOwner
          DataProcessStage: !Ref DataProcessStage
          LineOfBusiness: !Ref LineOfBusiness
              
# Outputs useful in other templates or to user
Outputs:
  TemplateVersion:
    Description: 'Template version.'
    Value: '1.0'

  TerraformLauncherStatus:
    Description: "TerraformLauncher status."
    Value: !GetAtt TerraformLauncher.status


